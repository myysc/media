name: Run HLS酒店

on:
  schedule:
    - cron: "0 10,18 * * *"
  workflow_dispatch:

jobs:
  run-itvlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp requests

      - name: 创建必要目录
        run: |
          mkdir -p ${{ github.workspace }}/py
          echo "必要目录已创建"

      - name: 从库复制文件
        env:
          REPOIPTV: ${{ secrets.REPOIPTV }}
        run: |
          echo "=== 开始从库复制文件 ==="
          
          # 克隆库到临时目录
          git clone https://${{ secrets.REPOIPTV }}@github.com/myysc/zbjdtv.git /tmp/private_repo
          
          # 复制 hls_jd.py 文件
          if [ -f "/tmp/private_repo/py/hls_jd.py" ]; then
            cp /tmp/private_repo/py/hls_jd.py ${{ github.workspace }}/py/hls_jd.py
            echo "已复制 hls_jd.py"
          else
            echo "警告: 库中未找到 py/hls_jd.py 文件"
          fi
          
          # 复制 hls_urls.txt 文件
          if [ -f "/tmp/private_repo/jdip/hls_urls.txt" ]; then
            cp /tmp/private_repo/jdip/hls_urls.txt ${{ github.workspace }}/ip_urls.txt
            echo "已复制 hls_urls.txt"
          else
            echo "警告: 库中未找到 hls_urls.txt 文件"
          fi
          
          echo "=== 库文件复制完成 ==="

      - name: Run ITV酒店
        run: |
          echo "=== Starting hls_jd.py ==="
          python py/hls_jd.py
          echo "=== Finished hls_jd.py ==="

      - name: 上传文件到库
        env:
          REPOIPTV: ${{ secrets.REPOIPTV }}
        run: |
          echo "=== 开始上传文件到库 ==="
          
          # 进入库目录
          cd /tmp/private_repo
          
          # 配置 git
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          # 创建 tv 目录（如果不存在）
          mkdir -p tv
          
          # 复制生成的 itvlist.txt 到库的 tv 文件夹并重命名为 jiudian.txt
          if [ -f "${{ github.workspace }}/itvlist.txt" ]; then
            cp ${{ github.workspace }}/itvlist.txt /tmp/private_repo/tv/jiudian.txt
            echo "已复制 itvlist.txt 到库 tv/jiudian.txt"
            
            # 提交并推送更改到库
            git add tv/jiudian.txt
            git commit -m "自动更新：jiudian.txt $(date +'%Y-%m-%d %H:%M:%S')" || echo "没有更改需要提交"
            git push origin main || echo "推送失败或无需推送"
          else
            echo "警告: 未找到生成的文件 itvlist.txt"
          fi
          
          echo "=== 库文件上传完成 ==="

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ip_urls.txt
          git commit -m "自定更新： ip_urls.txt" || echo "No changes"
          git push --force