name:  Live IPTVç»„æ’­

on:
  schedule:
    - cron: "0 8,23 * * *"
  workflow_dispatch:          # æ‰‹åŠ¨è§¦å‘

jobs:
  fetch-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: æ¸…ç†æ—§æ•°æ® ğŸ—‘ï¸
        run: |
          # åˆ é™¤fwipç›®å½•ä¸­çš„txtæ–‡ä»¶
          if [ -d "${{ github.workspace }}/fwip" ]; then
            find ${{ github.workspace }}/fwip -name "*.txt" -type f -delete
            echo "å·²æ¸…ç†fwipç›®å½•ä¸­çš„txtæ–‡ä»¶"
          fi

      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p ${{ github.workspace }}/fwip
          mkdir -p ${{ github.workspace }}/rtpudp
          mkdir -p ${{ github.workspace }}/py
          mkdir -p ${{ github.workspace }}/tv
          echo "å¿…è¦ç›®å½•å·²åˆ›å»º"

      - name: ä»åº“å¤åˆ¶æ–‡ä»¶
        run: |
          # å…‹éš†åº“åˆ°ä¸´æ—¶ç›®å½•
          git clone https://${{ secrets.REPOIPTV }}@github.com/myysc/zbjdtv.git /tmp/private-repo
          
          # å¤åˆ¶ zubo.py æ–‡ä»¶
          if [ -f "/tmp/private-repo/py/zubo.py" ]; then
            echo "å¤åˆ¶ zubo.py æ–‡ä»¶..."
            cp /tmp/private-repo/py/zubo.py ${{ github.workspace }}/py/
            echo "zubo.py å·²å¤åˆ¶"
          else
            echo "è­¦å‘Š: /tmp/private-repo/py/zubo.py ä¸å­˜åœ¨"
          fi
          
          # å¤åˆ¶ rtp æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ txt æ–‡ä»¶
          if [ -d "/tmp/private-repo/rtpudp" ]; then
            echo "å¤åˆ¶ rtpudp æ–‡ä»¶å¤¹ä¸­çš„ txt æ–‡ä»¶..."
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p ${{ github.workspace }}/rtpudp
            # å¤åˆ¶æ‰€æœ‰ txt æ–‡ä»¶
            cp /tmp/private-repo/rtpudp/*.txt ${{ github.workspace }}/rtpudp/ 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ° txt æ–‡ä»¶æˆ–ç›®å½•ä¸ºç©º"
            echo "rtp æ–‡ä»¶å·²å¤åˆ¶"
          else
            echo "è­¦å‘Š: /tmp/private-repo/rtpudp ç›®å½•ä¸å­˜åœ¨"
          fi
          
          # å¤åˆ¶ fwip æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ txt æ–‡ä»¶
          if [ -d "/tmp/private-repo/fwip" ]; then
            echo "å¤åˆ¶ fwip æ–‡ä»¶å¤¹ä¸­çš„ txt æ–‡ä»¶..."
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p ${{ github.workspace }}/fwip
            # å¤åˆ¶æ‰€æœ‰ txt æ–‡ä»¶
            cp /tmp/private-repo/fwip/*.txt ${{ github.workspace }}/fwip/ 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ° txt æ–‡ä»¶æˆ–ç›®å½•ä¸ºç©º"
            echo "fwip æ–‡ä»¶å·²å¤åˆ¶"
          else
            echo "è­¦å‘Š: /tmp/private-repo/fwip ç›®å½•ä¸å­˜åœ¨"
          fi

          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf /tmp/private-repo
          echo "åº“æ–‡ä»¶å¤åˆ¶å®Œæˆ"

      - name: Run ç»„æ’­
        run: python py/zubo.py

      - name: æ¨é€æ–‡ä»¶åˆ°åº“
        run: |
          # æ£€æŸ¥ tv/zubotv.txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "${{ github.workspace }}/tv/zubotv.txt" ]; then
            echo "é”™è¯¯: tv/zubotv.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æ¨é€åˆ°åº“"
            exit 0  # é€€å‡ºä½†ä¸ç»ˆæ­¢å·¥ä½œæµ
          fi
          
          echo "å¼€å§‹æ¨é€æ–‡ä»¶åˆ°åº“..."
          
          # å…‹éš†åº“åˆ°ä¸´æ—¶ç›®å½•
          git clone https://${{ secrets.REPOIPTV }}@github.com/myysc/zbjdtv.git /tmp/push-repo
          
          # è¿›å…¥åº“ç›®å½•
          cd /tmp/push-repo
          
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          
          # ç¡®ä¿ tv ç›®å½•å­˜åœ¨
          mkdir -p tv
          
          # å¤åˆ¶å¹¶é‡å‘½åæ–‡ä»¶
          cp "${{ github.workspace }}/tv/zubotv.txt" /tmp/push-repo/tv/zubotv.txt
          
          echo "æ–‡ä»¶å·²å¤åˆ¶åˆ°åº“ï¼Œå‡†å¤‡æäº¤..."
          
          # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
          git add tv/zubotv.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            # æäº¤å˜æ›´
            git commit -m "è‡ªåŠ¨æ›´æ–°: ä» ${{ github.repository }} åŒæ­¥ zubotv.txt ä¸º zubotv.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
            
            # æ¨é€åˆ°åº“
            echo "æ­£åœ¨æ¨é€åˆ°åº“..."
            git push origin main
            echo "æ–‡ä»¶å·²æˆåŠŸæ¨é€åˆ°åº“"
          fi
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          cd /
          rm -rf /tmp/push-repo
          echo "æ¨é€ä»»åŠ¡å®Œæˆ"

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git add fwip/*.txt || true
          git commit -m "è‡ªåŠ¨æ›´æ–°ï¼šIPæ–‡ä»¶" || echo "âš ï¸ æ— éœ€æäº¤"
          git push origin main || echo "âš ï¸ æ¨é€å¤±è´¥"